name: Update Homebrew Tap

on:
  release:
    types: [published]

jobs:
  update-tap:
    permissions:
      contents: read
    runs-on: ubuntu-latest
    steps:
      - id: release
        name: Get release information
        uses: actions/github-script@v6
        env:
          TAG_NAME: ${{ github.event.release.tag_name }}
        with:
          script: |
            const release = await github.rest.repos.getReleaseByTag({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag: process.env.TAG_NAME,
            });
            if (!release || !release.data || !release.data.assets) {
              core.setFailed(`Release or assets not found for tag: ${process.env.TAG_NAME}`);
              return;
            }

            const armDmg = release.data.assets.find(asset => asset.name.includes('arm64.dmg'));
            const intelDmg = release.data.assets.find(asset => asset.name.includes('.dmg') && !asset.name.includes('arm64'));
            const appImage = release.data.assets.find(asset => asset.name.includes('.AppImage'));

            if (!armDmg || !intelDmg || !appImage) {
              core.setFailed(`Missing required assets. Found: arm64.dmg=${!!armDmg}, intel.dmg=${!!intelDmg}, AppImage=${!!appImage}`);
              return;
            }

            return {
              version: release.data.tag_name.replace('v', ''),
              armDmgUrl: armDmg.browser_download_url,
              intelDmgUrl: intelDmg.browser_download_url,
              appImageUrl: appImage.browser_download_url,
            };

      - name: Download assets and compute SHA256
        if: steps.release.outputs.result
        id: sha256
        env:
          ARM_DMG_URL: ${{ fromJson(steps.release.outputs.result).armDmgUrl }}
          INTEL_DMG_URL: ${{ fromJson(steps.release.outputs.result).intelDmgUrl }}
          APPIMAGE_URL: ${{ fromJson(steps.release.outputs.result).appImageUrl }}
        run: |
          echo "Downloading and computing SHA256 hashes..."

          SHAOSXARM=$(curl -sL "$ARM_DMG_URL" | sha256sum | cut -d' ' -f1)
          echo "ARM DMG SHA256: $SHAOSXARM"
          echo "shaosxarm=$SHAOSXARM" >> $GITHUB_OUTPUT

          SHAOSXINTEL=$(curl -sL "$INTEL_DMG_URL" | sha256sum | cut -d' ' -f1)
          echo "Intel DMG SHA256: $SHAOSXINTEL"
          echo "shaosxintel=$SHAOSXINTEL" >> $GITHUB_OUTPUT

          SHALINUX=$(curl -sL "$APPIMAGE_URL" | sha256sum | cut -d' ' -f1)
          echo "AppImage SHA256: $SHALINUX"
          echo "shalinux=$SHALINUX" >> $GITHUB_OUTPUT

      - name: Checkout homebrew-pubman
        if: steps.release.outputs.result
        uses: actions/checkout@v4
        with:
          repository: DrawnToDigital/homebrew-pubman
          path: homebrew-pubman
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}

      - name: Update Cask
        if: steps.release.outputs.result
        shell: bash
        env:
          VERSION: ${{ fromJson(steps.release.outputs.result).version }}
          SHAOSXARM: ${{ steps.sha256.outputs.shaosxarm }}
          SHAOSXINTEL: ${{ steps.sha256.outputs.shaosxintel }}
          SHALINUX: ${{ steps.sha256.outputs.shalinux }}
        run: |
          if [[ -z "$VERSION" || -z "$SHAOSXARM" || -z "$SHAOSXINTEL" || -z "$SHALINUX" ]]; then
            echo "Missing required release info:"
            echo "  VERSION=$VERSION"
            echo "  SHAOSXARM=$SHAOSXARM"
            echo "  SHAOSXINTEL=$SHAOSXINTEL"
            echo "  SHALINUX=$SHALINUX"
            exit 1
          fi

          cd homebrew-pubman

          # Update version and SHA256
          sed -i "s|version \".*\"|version \"$VERSION\"|" Casks/pubman.rb
          sed -i "s|sha256 arm:   \".*\"|sha256 arm:   \"$SHAOSXARM\"|" Casks/pubman.rb
          sed -i "s|intel: \".*\"|intel: \"$SHAOSXINTEL\"|" Casks/pubman.rb
          sed -i "s|version \".*\"|version \"$VERSION\"|" Formula/pubman-linux.rb
          sed -i "s|sha256 \".*\"|sha256 \"$SHALINUX\"|" Formula/pubman-linux.rb

          # Commit and push changes
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add Casks/pubman.rb Formula/pubman-linux.rb
          git commit -m "Update cask to version $VERSION"
          git push
